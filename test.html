<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>parkrunner tourist</title>
    <link rel="shortcut icon" type="image/x.icon" href="favicon.ico?">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-REFFZSK4XK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-REFFZSK4XK');
    </script>

    <!-- Cronitor RUM -->
    <script async src="https://rum.cronitor.io/script.js"></script>
    <script>
        window.cronitor = window.cronitor || function() { (window.cronitor.q = window.cronitor.q || []).push(arguments); };
        cronitor('config', { clientKey: '7d03d6af0f794abeb3988b05dc158a14' });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap');
        
        :root {
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --glass-backdrop: blur(20px);
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --text-primary: rgba(0, 0, 0, 0.87);
            --text-secondary: rgba(0, 0, 0, 0.6);
            --border-radius: 16px;
            --border-radius-small: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            -moz-user-select: none;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        #map {
            height: 100vh;
            width: 100vw;
            filter: saturate(1.1) contrast(1.05);
        }

        /* Glass morphism controls */
        .controls {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-backdrop);
            -webkit-backdrop-filter: var(--glass-backdrop);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 20px;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            box-shadow: var(--glass-shadow);
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-width: 200px;
            transition: var(--transition);
        }

        .controls:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .controls.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        .controls label {
            display: flex;
            align-items: center;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .controls label:hover {
            color: #667eea;
        }

        .controls input[type="checkbox"] {
            appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            margin-right: 12px;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.1);
        }

        .controls input[type="checkbox"]:checked {
            background: var(--primary-gradient);
            border-color: transparent;
            transform: scale(1.05);
        }

        .controls input[type="checkbox"]:checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        /* Glass morphism buttons */
        .glass-button {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-backdrop);
            -webkit-backdrop-filter: var(--glass-backdrop);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-small);
            padding: 14px 24px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: block;
            text-align: center;
            box-shadow: var(--glass-shadow);
            position: relative;
            overflow: hidden;
        }

        .glass-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
            z-index: -1;
        }

        .glass-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .glass-button:hover::before {
            opacity: 1;
        }

        .glass-button:active {
            transform: translateY(0);
        }

        /* Specific button styles */
        .hotel-btn::before { background: var(--secondary-gradient); }
        .course-btn::before { background: var(--success-gradient); }
        .volunteer-btn::before { background: var(--warning-gradient); }
        .direction-btn::before { background: var(--danger-gradient); }

        /* Search container */
        #search-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #search-icon {
            width: 48px;
            height: 48px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-backdrop);
            -webkit-backdrop-filter: var(--glass-backdrop);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--glass-shadow);
            color: var(--text-primary);
            font-size: 20px;
        }

        #search-icon:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        #search-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        #search-input {
            width: 0;
            opacity: 0;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-backdrop);
            -webkit-backdrop-filter: var(--glass-backdrop);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-small);
            padding: 14px 20px;
            font-size: 16px;
            color: var(--text-primary);
            transition: var(--transition);
            box-shadow: var(--glass-shadow);
            user-select: text;
            -webkit-user-select: text;
        }

        #search-input::placeholder {
            color: rgba(0, 0, 0, 0.4);
        }

        #search-input.show {
            width: 300px;
            opacity: 1;
        }

        #search-input:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), var(--glass-shadow);
        }

        #clear-btn {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 18px;
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition);
        }

        #clear-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }

        /* Location button */
        .location-button {
            position: absolute;
            top: 88px;
            right: 20px;
            z-index: 1000;
            width: 48px;
            height: 48px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-backdrop);
            -webkit-backdrop-filter: var(--glass-backdrop);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--glass-shadow);
            color: var(--text-primary);
            font-size: 20px;
        }

        .location-button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        /* Popup styles */
        .leaflet-popup-content-wrapper {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-backdrop);
            -webkit-backdrop-filter: var(--glass-backdrop);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--glass-shadow);
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 0;
            padding: 20px;
            color: var(--text-primary);
        }

        .popup-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
            text-align: center;
        }

        .hotel-popup-image {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius-small);
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }

        .hotel-popup-image:hover {
            transform: scale(1.02);
        }

        /* Notifications */
        .notifications {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 90%;
            z-index: 9999;
        }

        .notifications .toast {
            max-width: 400px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-backdrop);
            -webkit-backdrop-filter: var(--glass-backdrop);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--glass-shadow);
            animation: show_toast 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            color: var(--text-primary);
        }

        @keyframes show_toast {
            0% {
                transform: translateY(100%) scale(0.9);
                opacity: 0;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .toast::before {
            content: "";
            height: 4px;
            width: 100%;
            position: absolute;
            bottom: 0;
            left: 0;
            animation: progress 2.5s linear forwards;
            background: var(--danger-gradient);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        @keyframes progress {
            100% {
                width: 0%;
            }
        }

        .toast .column {
            display: flex;
            align-items: center;
        }

        .toast .column i {
            font-size: 1.5rem;
            color: #fa709a;
            margin-right: 12px;
        }

        .toast .column span {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* iframe styling */
        iframe {
            width: 100%;
            border: none;
            overflow: hidden;
            border-radius: var(--border-radius-small);
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Map overlay */
        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            z-index: 900;
            display: none;
            cursor: not-allowed;
        }

        /* Hide attribution */
        .leaflet-control-attribution {
            display: none;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .controls {
                left: 10px;
                top: 10px;
                padding: 16px;
                min-width: 160px;
            }

            #search-container {
                top: 10px;
                right: 10px;
            }

            .location-button {
                top: 78px;
                right: 10px;
            }

            #search-input.show {
                width: 250px;
            }

            .popup-title {
                font-size: 16px;
            }
        }

        /* Enhanced button hover effects */
        .glass-button {
            position: relative;
            overflow: hidden;
        }

        .glass-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .glass-button:active::after {
            width: 300px;
            height: 300px;
        }

        /* Smooth scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="locationButton" class="location-button" onclick="returnToLocation()">
        <i class="fas fa-crosshairs"></i>
    </div>
    <div id="search-container">
        <i id="search-icon" class="fas fa-search"></i>
        <div id="search-input-container">
            <input type="text" id="search-input" placeholder="Search locations...">
            <button id="clear-btn"><i class="fas fa-times"></i></button>
        </div>
    </div>
    <ul class="notifications"></ul>
    <div id="map-overlay" class="map-overlay"></div>
    <div class="controls">
        <label>
            <input type="checkbox" id="fiveKCheckbox" checked>
            <span>5K Events</span>
        </label>
        <label>
            <input type="checkbox" id="juniorCheckbox" checked>
            <span>Junior Events</span>
        </label>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        // All the original JavaScript functionality remains the same
        function getCountryUrl(lat, lon) {
            const countries = {
                "3": { "url": "http://www.parkrun.com.au", "bounds": [113.654841, -43.163256, 153.578901, -12.376205] },
                "4": { "url": "http://www.parkrun.co.at", "bounds": [13.065462, 47.075123, 16.419671, 48.318131] },
                "14": { "url": "http://www.parkrun.ca", "bounds": [-123.650306, 42.990553, -57.937618, 56.733336] },
                "23": { "url": "http://www.parkrun.dk", "bounds": [8.442703, 55.474609, 12.635341, 56.987144] },
                "30": { "url": "http://www.parkrun.fi", "bounds": [23.759243, 60.177056, 25.732898, 65.015719] },
                "31": { "url": "http://www.parkrun.fr", "bounds": [-0.42901, 43.564162, 6.146281, 49.44128] },
                "32": { "url": "http://www.parkrun.com.de", "bounds": [6.084436, 47.586611, 13.762586, 53.70882] },
                "42": { "url": "http://www.parkrun.ie", "bounds": [-10.082041, 51.551575, -6.099962, 55.140535] },
                "44": { "url": "http://www.parkrun.it", "bounds": [9.211192, 37.621125, 18.166117, 45.694128] },
                "46": { "url": "http://www.parkrun.jp", "bounds": [130.673031, 31.908209, 141.125657, 39.692853] },
                "54": { "url": "http://www.parkrun.lt", "bounds": [20.9415, 53.8968, 26.8355, 56.4504] },        
                "57": { "url": "http://www.parkrun.my", "bounds": [101.698056, 2.916852, 101.698056, 2.916852] },
                "64": { "url": "http://www.parkrun.co.nl", "bounds": [4.290593, 50.843369, 6.883689, 53.214822] },
                "65": { "url": "http://www.parkrun.co.nz", "bounds": [167.688869, -46.404097, 178.018082, -35.734968] },
                "67": { "url": "http://www.parkrun.no", "bounds": [5.322763, 58.952586, 11.068693, 63.430394] },
                "74": { "url": "http://www.parkrun.pl", "bounds": [14.1229, 49.002, 24.1458, 54.8358] },
                "82": { "url": "http://www.parkrun.sg", "bounds": [103.762915, 1.294155, 103.893129, 1.360729] },
                "85": { "url": "http://www.parkrun.co.za", "bounds": [14.481783, -34.820522, 32.27309, -22.618415] },
                "88": { "url": "http://www.parkrun.se", "bounds": [11.943555, 55.60278, 20.249958, 63.826124] },
                "97": { "url": "http://www.parkrun.org.uk", "bounds": [-7.643103, 40.929141, 14.046913, 60.158081] },
                "98": { "url": "http://www.parkrun.us", "bounds": [-122.862376, 27.84707, -69.954915, 48.468375] }
            };

            for (let country in countries) {
                const { url, bounds } = countries[country];
                const [minLng, minLat, maxLng, maxLat] = bounds;

                if (lat >= minLat && lat <= maxLat && lon >= minLng && lon <= maxLng) {
                    return url;
                }
            }

            return "http://www.parkrun.org.uk";
        }

        function openUrl(url) {
            window.open(url, '_blank');
        }

        // Disable touch-and-hold context menus on mobile devices except for #search-container
        document.addEventListener('touchstart', function(e) {
            if (!e.target.closest('#search-container') && e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchend', function(e) {
            if (!e.target.closest('#search-container') && e.timeStamp - e.targetTouches[0].startTime > 500) {
                e.preventDefault();
            }
        });

        document.addEventListener('mousedown', function(e) {
            if (!e.target.closest('#search-container')) {
                e.preventDefault();
            }
        });

        document.addEventListener('dragstart', function(e) {
            if (!e.target.closest('#search-container')) {
                e.preventDefault();
            }
        });

        document.addEventListener('contextmenu', function(e) {
            if (e.target.closest('.leaflet-popup-content') && !e.target.closest('#search-container')) {
                e.preventDefault();
            }
        });

        function getCityName(lat, lon) {
            return fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
                .then(response => response.json())
                .then(data => data.address.city || data.address.village || data.address.town || 'Unknown');
        }

        // Map initialization with URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const lat = parseFloat(urlParams.get('lat'));
        const lon = parseFloat(urlParams.get('lon'));
        const zoom = parseInt(urlParams.get('zoom')) || 13; 

        const hasValidCoords = !isNaN(lat) && !isNaN(lon);

        var map = L.map('map', {
            center: hasValidCoords ? [lat, lon] : [0, 0],
            zoom: hasValidCoords ? zoom : 2,
            zoomControl: false,
            maxBounds: [[-90, -180], [90, 180]],
            maxBoundsViscosity: 1.0,
            minZoom: 2,
            worldCopyJump: false
        });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 19
        }).addTo(map);

        function updateURL() {
            const center = map.getCenter();
            const zoom = map.getZoom();
            const newUrl = `${window.location.pathname}?lat=${center.lat.toFixed(6)}&lon=${center.lng.toFixed(6)}&zoom=${zoom}`;
            window.history.replaceState({}, '', newUrl);
        }

        map.on('moveend', updateURL);

        var userLocationMarker;

        function onLocationFound(e) {
            if (!userLocationMarker) {
                userLocationMarker = L.marker(e.latlng, { icon: LocationIcon }).addTo(map)
                    .bindPopup("You are here");
            } else {
                userLocationMarker.setLatLng(e.latlng);
            }

            if (!hasValidCoords) {
                map.setView(e.latlng, 13);
            }
        }

        map.on('locationfound', onLocationFound);

        if (!hasValidCoords) {
            map.locate({ setView: true, maxZoom: 13 });
        } else {
            map.locate({ setView: false });
        }

        // Icon definitions
        var juniorIcon = L.icon({
            iconUrl: '/Icons/Junior.png',
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -38]
        });

        var fiveKIcon = L.icon({
            iconUrl: '/Icons/5k.png',
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -38]
        });

        var LocationIcon = L.icon({
            iconUrl: '/Icons/Me.png',
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -38]
        });

        var bbIcon = L.icon({
           iconUrl: 'Icons/BB.png',
           iconSize: [38, 38],
           iconAnchor: [19, 38],
           popupAnchor: [0, -38]
        });

        var canceledIcon = L.icon({
           iconUrl: '/Icons/Cancel.png',
           iconSize: [38, 38],
           iconAnchor: [19, 38],
           popupAnchor: [0, -38]
        });

        const cafeIcon = L.icon({
           iconUrl: 'Icons/Cafe.png',
           iconSize: [38, 38],
           iconAnchor: [19, 38],
           popupAnchor: [0, -38],
        });

        const hotelIcon = L.icon({
            iconUrl: '/Icons/Hotel.png',
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -38],
        });

        const campsiteIcon = L.icon({
            iconUrl: '/Icons/Camp.png',
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -38],
        });

        const caravanIcon = L.icon({
            iconUrl: '/Icons/Caravan.png',
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -38],
        });

        var bbMarkers = [];
        var data = {};
        var cancellations = {};
        var markers = L.markerClusterGroup();

        function normalizeEventName(name) {
            if (!name) return '';
            return name.toLowerCase().replace(/\s+/g, '').replace('parkrun', '');
        }

        async function fetchLocationData() {
            const url = '/BBS/Locations.json';
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                return data.locations;
            } catch (error) {
                console.error('Failed to fetch the location data:', error);
                return null;
            }
        }

        function addMarkersToMap(locations) {
            locations.forEach(location => {
                const lat = location.coordinates.latitude;
                const lon = location.coordinates.longitude;
                const name = location.name;
                const description = location.description;
                const phone = location.phone;
                const website = location.website;
                const image = location.image_link;

                const bbMarker = L.marker([lat, lon], { icon: bbIcon })
                    .bindPopup(
                        `<div style="width: 200px;">
                            <img src="${image}" alt="${name}" class="hotel-popup-image">
                            <div style="padding: 10px;">
                                <div class="popup-title">${name}</div>
                                <p style="margin-bottom: 16px; color: var(--text-secondary);">${description}</p>
                                <a href="${website}" target="_blank" style="text-decoration: none;">
                                    <button class="glass-button hotel-btn" style="width: 100%; margin-bottom: 8px;">
                                        <i class="fas fa-globe"></i> Visit Website
                                    </button>
                                </a>
                                <button class="glass-button hotel-btn" style="width: 100%;" onclick="window.location.href='tel:${phone}'">
                                    <i class="fas fa-phone"></i> ${phone}
                                </button>
                            </div>
                        </div>`
                    );

                bbMarkers.push(bbMarker);
            });

            updateMarkerVisibility();
        }

        function updateMarkerVisibility() {
            if (map.getZoom() < 13) {
                bbMarkers.forEach(marker => {
                    map.removeLayer(marker);
                });
            } else {
                bbMarkers.forEach(marker => {
                    map.addLayer(marker);
                });
            }
        }

        map.on('zoomend', updateMarkerVisibility);

        var locationButton = document.getElementById("locationButton");

        function returnToLocation() {
            if (userLocationMarker) {
                map.flyTo(userLocationMarker.getLatLng(), 13, { duration: 1.5 });
            } else {
                map.locate({ setView: true, maxZoom: 13 });
            }
        }

        let canCreateToast = true;

        map.on('locationerror', function() {
          if (canCreateToast) {
            createToast();
            canCreateToast = false;
            setTimeout(function() {
              canCreateToast = true;
            }, 2500); 
          }
        });

        map.on('moveend', function() {
            if (userLocationMarker) {
                var bounds = map.getBounds();
                var isUserLocationVisible = bounds.contains(userLocationMarker.getLatLng());
                locationButton.style.display = isUserLocationVisible ? "none" : "block";
            }
        });

        const notifications = document.querySelector(".notifications");

        const toastDetails = {
            timer: 2500, 
            error: {
                icon: 'fa-triangle-exclamation',
                text: 'Cannot find your location',
            }
        };

        const removeToast = (toast) => {
            toast.classList.add("hide");
            setTimeout(() => toast.remove(), 500);
        }

        const createToast = () => {
            const { icon, text } = toastDetails.error;
            const toast = document.createElement("li");
            toast.className = `toast`;
            toast.innerHTML = `<div class="column">
                                 <i class="fa-solid ${icon}"></i>
                                 <span>${text}</span>
                              </div>`;
            notifications.appendChild(toast);
            setTimeout(() => {
                removeToast(toast);
            }, toastDetails.timer);
        }

        fetchLocationData().then(data => {
            if (data && Array.isArray(data)) {
                addMarkersToMap(data);
            } else {
                console.error('Invalid location data');
            }
        });

        function fetchLocationCoordinates(place) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`;
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const location = data[0];
                        return {
                            lat: parseFloat(location.lat),
                            lon: parseFloat(location.lon),
                            boundingBox: location.boundingbox.map(coord => parseFloat(coord)),
                        };
                    }
                    throw new Error("Location not found");
                });
        }

        fetch('/cancellations.json')
            .then(response => response.json())
            .then(data => {
                cancellations = {};
                data.forEach(item => {
                    let normalizedKey = normalizeEventName(item.name);
                    cancellations[normalizedKey] = item.reason;
                });
                updateMapMarkers();
            })
            .catch(err => console.error('Error fetching cancellation data:', err));

        function updateMapMarkers() {
            markers.clearLayers();

            if (!data.events) return;

            data.events.features.forEach(function (feature) {
                if (feature.geometry.type === 'Point') {
                    var coordinates = feature.geometry.coordinates;
                    var eventname = normalizeEventName(feature.properties.eventname);
                    var eventLongName = feature.properties.EventLongName;

                    var isJunior = eventLongName.toLowerCase().includes('junior');
                    var showMarker = (isJunior && document.getElementById('juniorCheckbox').checked) ||
                        (!isJunior && document.getElementById('fiveKCheckbox').checked);

                    if (showMarker) {
                        var countryUrl = getCountryUrl(coordinates[1], coordinates[0]);
                        
                        var weatherUrl = `https://parkrunnertourist.co.uk/weather?lat=${coordinates[1]}&lon=${coordinates[0]}`;
                        if (isJunior) {
                            weatherUrl += '&junior';
                        }

                        var popupContent = `
                            <div>
                                <div class="popup-title">${eventLongName}</div>
                                <iframe id="weatherIframe" src="${weatherUrl}" scrolling="no"></iframe>
                                <button class="glass-button course-btn" onclick="openUrl('${countryUrl}/${eventname}/course/')" style="width: 100%; margin-bottom: 8px;">
                                    <i class="fas fa-route"></i> Course
                                </button>
                                <button class="glass-button volunteer-btn" onclick="openUrl('${countryUrl}/${eventname}/futureroster/')" style="width: 100%; margin-bottom: 8px;">
                                    <i class="fas fa-hands-helping"></i> Volunteer
                                </button>
                                <button class="glass-button direction-btn" onclick="openDirections(${coordinates[1]}, ${coordinates[0]})" style="width: 100%;">
                                    <i class="fas fa-directions"></i> Directions
                                </button>
                            </div>
                        `;

                        var markerIcon = isJunior ? juniorIcon : fiveKIcon;
                        if (cancellations[eventname]) {
                            popupContent = `
                                <div>
                                    <div class="popup-title">${eventLongName}</div>
                                    <div style="color: #fa709a; font-weight: 600; margin-bottom: 16px; padding: 12px; background: rgba(250, 112, 154, 0.1); border-radius: 8px;">
                                        <i class="fas fa-exclamation-triangle"></i> Cancelled: ${cancellations[eventname]}
                                    </div>
                                    <button class="glass-button course-btn" onclick="openUrl('${countryUrl}/${eventname}/course/')" style="width: 100%; margin-bottom: 8px;">
                                        <i class="fas fa-route"></i> Course
                                    </button>
                                    <button class="glass-button volunteer-btn" onclick="openUrl('${countryUrl}/${eventname}/futureroster/')" style="width: 100%; margin-bottom: 8px;">
                                        <i class="fas fa-hands-helping"></i> Volunteer
                                    </button>
                                    <button class="glass-button direction-btn" onclick="openDirections(${coordinates[1]}, ${coordinates[0]})" style="width: 100%;">
                                        <i class="fas fa-directions"></i> Directions
                                    </button>
                                </div>
                            `;
                            markerIcon = canceledIcon;
                        }

                        var marker = L.marker([coordinates[1], coordinates[0]], { icon: markerIcon })
                            .bindPopup(popupContent);

                        marker.on('click', function () {
                            console.log(`Marker clicked at: ${coordinates[1]}, ${coordinates[0]}`);
                            findNearbyPlaces(coordinates[1], coordinates[0]);
                        });

                        markers.addLayer(marker);
                    }
                }
            });

            map.addLayer(markers);
        }

        const tomTomApiKey = 'dAvRoz8Z1SA4K6JM5l6XnJMGPwc7GQmG';

        function findNearbyPlaces(lat, lng) {
            console.log(`Searching for hotels and campsites near: ${lat}, ${lng}`);
            fetchTomTomPlaces(lat, lng, 'CAFE_PUB', cafeIcon);
            fetchTomTomPlaces(lat, lng, 'hotel', hotelIcon);
            fetchTomTomPlaces(lat, lng, 'camping ground', campsiteIcon);
        }

        function fetchTomTomPlaces(lat, lng, category, icon) {
            const searchUrl = `https://api.tomtom.com/search/2/categorySearch/${category}.json?lat=${lat}&lon=${lng}&radius=9000&key=${tomTomApiKey}`;

            fetch(searchUrl)
                .then(response => response.json())
                .then(data => {
                    console.log(`TomTom ${category} API Response:`, data);

                    if (data.results && data.results.length > 0) {
                        data.results.forEach(place => {
                            createPlaceMarker(place, category, icon);
                        });
                    } else {
                        console.log(`No ${category}s found within 9km.`);
                    }
                })
                .catch(error => console.error(`Error fetching ${category} data:`, error));
        }

        function createPlaceMarker(place, type, icon) {
            const lat = place.position.lat;
            const lon = place.position.lon;
            const name = place.poi?.name || "No Name Available";
            const address = place.address?.freeformAddress || "Address not available";
            const phoneNumber = place.poi?.phone || null;
            const websiteUrl = place.poi?.url || null;
            const imageUrl = place.poi?.imageUrl || null;

            let buttonColor = "#c8a367";
            let buttonHoverColor = "#b0874e";

            if (type === "camping") {
                buttonColor = "#0d7640";
                buttonHoverColor = "#0a5a30";
            } else if (type.toLowerCase().includes("caravan")) {
                buttonColor = "#046e7b";
                buttonHoverColor = "#03505d";
            } else if (type.toLowerCase().includes("cafe")) {
                buttonColor = "#4b1f2c";
                buttonHoverColor = "#702f45";
            }

            let popupContent = `
                <div class="hotel-popup" style="--button-color: ${buttonColor}; --button-hover-color: ${buttonHoverColor}">
                    <div class="popup-title">${name}</div>
            `;

            if (imageUrl) {
                popupContent += `<img src="${imageUrl}" alt="${name}" class="hotel-popup-image" />`;
            }

            popupContent += `
                <button class="glass-button" onclick="openDirections(${lat}, ${lon})" style="width: 100%; margin-bottom: 8px;">
                    <i class="fas fa-map-marker-alt"></i> Directions
                </button>
                ${websiteUrl ? `
                    <button class="glass-button" onclick="openWebsite('${websiteUrl}')" style="width: 100%; margin-bottom: 8px;">
                        <i class="fas fa-globe"></i> Visit Website
                    </button>
                ` : `
                    <button class="glass-button" disabled style="width: 100%; margin-bottom: 8px; opacity: 0.5;">
                        <i class="fas fa-globe"></i> No Website
                    </button>
                `}
                ${phoneNumber ? `
                    <a href="tel:${phoneNumber}" style="text-decoration: none;">
                        <button class="glass-button" style="width: 100%;">
                            <i class="fas fa-phone"></i> Call
                        </button>
                    </a>
                ` : `
                    <button class="glass-button" disabled style="width: 100%; opacity: 0.5;">
                        <i class="fas fa-phone"></i> No Phone
                    </button>
                `}
            </div>
            `;

            L.marker([lat, lon], { icon }).bindPopup(popupContent).addTo(map);
        }

        fetch('/events1.json')
            .then(response => response.json())
            .then(jsonData => {
                data = jsonData;
                updateMapMarkers();

                document.getElementById('juniorCheckbox').addEventListener('change', updateMapMarkers);
                document.getElementById('fiveKCheckbox').addEventListener('change', updateMapMarkers);
            })
            .catch(err => {
                console.error('Error fetching GeoJSON:', err);
                handleGeocodingError();
            });

        function handleGeocodingError() {
            window.location.href = 'https://parkrunnertourist.co.uk/Error';
        }

        window.addEventListener('load', () => {
            const consentButton = document.querySelector('.VfPpkd-RLmnJb');
            if (consentButton) {
                consentButton.click();
            }
        });

        function openDirections(lat, lon) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
            window.open(url, '_blank');
        }

        function openHotelMap(lat, lon) {
           const url = `https://www.google.com/maps/search/Hotels/@${lat},${lon},18.5z`;
           window.open(url, '_blank');
        }

        function openWebsite(url) {
            if (!/^https?:\/\//i.test(url)) {
                url = 'https://' + url;
            }
            window.open(url, '_blank');
        }

        var userLocationMarker = null;
        var locationCircle = null;

        function onLocationError(e) {
            // Handle location error silently
        }

        // Search functionality
        document.getElementById('search-icon').addEventListener('click', function() {
            var input = document.getElementById('search-input');
            var clearBtn = document.getElementById('clear-btn');
            var searchIcon = document.getElementById('search-icon');
            input.classList.toggle('show');
            clearBtn.style.display = input.classList.contains('show') ? 'block' : 'none';
            searchIcon.classList.toggle('hidden', input.classList.contains('show'));
            if (input.classList.contains('show')) {
                input.focus();
            }
        });

        document.getElementById('clear-btn').addEventListener('click', function() {
            var input = document.getElementById('search-input');
            var searchIcon = document.getElementById('search-icon');
            input.value = '';
            input.classList.remove('show');
            this.style.display = 'none';
            searchIcon.classList.remove('hidden');
            updateMapMarkers();
        });

        function debounce(func, delay) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => func.apply(this, args), delay);
            };
        }

        document.getElementById('search-input').addEventListener(
            'input',
            debounce(function () {
                const searchValue = this.value.trim().toLowerCase();
                markers.clearLayers();

                if (searchValue) {
                    fetchLocationCoordinates(searchValue)
                        .then(({ lat, lon, boundingBox }) => {
                            const [south, north, west, east] = boundingBox;

                            const filteredMarkers = [];
                            data.events.features.forEach(feature => {
                                if (feature.geometry.type === 'Point') {
                                    const [lonEvent, latEvent] = feature.geometry.coordinates;
                                    const eventLongName = feature.properties.EventLongName.toLowerCase();

                                    const isJunior = eventLongName.includes('junior');
                                    const markerIcon = isJunior ? juniorIcon : fiveKIcon;

                                    if (
                                        latEvent >= south &&
                                        latEvent <= north &&
                                        lonEvent >= west &&
                                        lonEvent <= east
                                    ) {
                                        const eventname = feature.properties.eventname;
                                        const countryUrl = getCountryUrl(latEvent, lonEvent);

                                        const popupContent = `
                                            <div>
                                                <div class="popup-title">${feature.properties.EventLongName}</div>
                                                <iframe id="weatherIframe" src="https://parkrunnertourist.co.uk/weather?lat=${latEvent}&lon=${lonEvent}" scrolling="no"></iframe>
                                                <button class="glass-button course-btn" onclick="openUrl('${countryUrl}/${eventname}/course/')" style="width: 100%; margin-bottom: 8px;">
                                                    <i class="fas fa-route"></i> Course
                                                </button>
                                                <button class="glass-button volunteer-btn" onclick="openUrl('${countryUrl}/${eventname}/futureroster/')" style="width: 100%; margin-bottom: 8px;">
                                                    <i class="fas fa-hands-helping"></i> Volunteer
                                                </button>
                                                <button class="glass-button direction-btn" onclick="openDirections(${latEvent}, ${lonEvent})" style="width: 100%;">
                                                    <i class="fas fa-directions"></i> Directions
                                                </button>
                                            </div>
                                        `;

                                        const marker = L.marker([latEvent, lonEvent], { icon: markerIcon })
                                            .bindPopup(popupContent)
                                            .on('click', function () {
                                                findNearbyPlaces(latEvent, lonEvent);
                                            });

                                        markers.addLayer(marker);
                                        filteredMarkers.push(marker);
                                    }
                                }
                            });

                            if (filteredMarkers.length > 0) {
                                map.addLayer(markers);
                                const group = L.featureGroup(filteredMarkers);
                                map.fitBounds(group.getBounds());
                            } else {
                                displayNoResultsMessage();
                            }
                        })
                        .catch(err => {
                            console.warn("Location not found:", err);

                            const matchingEvents = [];
                            data.events.features.forEach(function (feature) {
                                if (feature.geometry.type === 'Point') {
                                    const eventLongName = feature.properties.EventLongName.toLowerCase();
                                    const isJunior = eventLongName.includes('junior');
                                    const markerIcon = isJunior ? juniorIcon : fiveKIcon;

                                    if (eventLongName.includes(searchValue)) {
                                        matchingEvents.push({ feature, markerIcon });
                                    }
                                }
                            });

                            if (matchingEvents.length > 0) {
                                const filteredMarkers = matchingEvents.map(({ feature, markerIcon }) => {
                                    const [lonEvent, latEvent] = feature.geometry.coordinates;
                                    const eventname = feature.properties.eventname;

                                    const popupContent = `
                                        <div>
                                            <div class="popup-title">${feature.properties.EventLongName}</div>
                                            <iframe id="weatherIframe" src="https://parkrunnertourist.co.uk/weather?lat=${latEvent}&lon=${lonEvent}" scrolling="no"></iframe>
                                            <button class="glass-button course-btn" onclick="openUrl('https://www.parkrun.org.uk/${eventname}/course/')" style="width: 100%; margin-bottom: 8px;">
                                                <i class="fas fa-route"></i> Course
                                            </button>
                                            <button class="glass-button volunteer-btn" onclick="openUrl('https://www.parkrun.org.uk/${eventname}/futureroster/')" style="width: 100%; margin-bottom: 8px;">
                                                <i class="fas fa-hands-helping"></i> Volunteer
                                            </button>
                                            <button class="glass-button direction-btn" onclick="openDirections(${latEvent}, ${lonEvent})" style="width: 100%;">
                                                <i class="fas fa-directions"></i> Directions
                                            </button>
                                        </div>
                                    `;

                                    const marker = L.marker([latEvent, lonEvent], { icon: markerIcon })
                                        .bindPopup(popupContent)
                                        .on('click', function () {
                                            findNearbyPlaces(latEvent, lonEvent);
                                        });

                                    markers.addLayer(marker);
                                    return marker;
                                });

                                map.addLayer(markers);

                                if (matchingEvents.length === 1) {
                                    const [lon, lat] = matchingEvents[0].feature.geometry.coordinates;
                                    map.setView([lat, lon], 15);
                                } else {
                                    const group = L.featureGroup(filteredMarkers);
                                    map.fitBounds(group.getBounds());
                                }
                            } else {
                                displayNoResultsMessage();
                            }
                        });
                } else {
                    updateMapMarkers();
                }
            }, 500)
        );

        function displayNoResultsMessage() {
            const input = document.getElementById('search-input');

            input.style.borderColor = '#FFC107'; 
            input.style.boxShadow = '0 0 8px #FFC107';
            input.style.borderWidth = '2px';

            setTimeout(() => {
                input.style.borderColor = '';
                input.style.boxShadow = '';
                input.style.borderWidth = '';
            }, 3000);
        }
    </script>
</body>
</html>
